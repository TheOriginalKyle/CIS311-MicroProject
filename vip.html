<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bootstrap Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

    <!-- navmenu source -->
    <script src="./nav.js"></script>

    <!-- can't be shoved in nav.js cause weird stuff happens -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.18.min.js"></script>
    <script id="facebook-jssdk" src="https://connect.facebook.net/en_US/all.js"></script>


  </head>
  <body>
    <script>dependencies()</script>

    <!-- create navigation menu -->
    <script>nav()</script>
    <!-- Modify's navigation menu to set current page to active -->
    <script>document.getElementById("vipPg").setAttribute("class", "nav-link active")</script>

    <div class="jumbotron jumbotron-fluid">
      <div class="container">
        <form id="form-div">
          <div class="form-group" id="unameDiv">
            <label for="uname" id="unameLbl">Username</label>
            <div class="alert alert-warning" role="alert" id="invalid_unameDiv" hidden>Cannot be blank!</div>
            <input type="username" class="form-control" id="uname" aria-describedby="usernameHelp" placeholder="BeefyUnicorn" oninput="notBlank('uname', true), enableBtn()">
          </div>
          <div class="form-group" id="firstNameDiv" hidden>
            <label for="firstName" id="firstNameLbl">*First Name</label>
            <div class="alert alert-warning" role="alert" id="invalid_firstNameDiv" hidden>Cannot be blank!</div>
            <input type="given-name" class="form-control" id="firstName" aria-describedby="usernameHelp" placeholder="Ted" oninput="notBlank('firstName', true), enableBtn()">
          </div>
          <div class="form-group" id="lastNameDiv" hidden>
            <label for="lastName" id="lastNameLbl">*Last Name</label>
            <div class="alert alert-warning" role="alert" id="invalid_lastNameDiv" hidden>Cannot be blank!</div>
            <input type="family-name" class="form-control" id="lastName" aria-describedby="usernameHelp" placeholder="Mosby" oninput="notBlank('lastName', true), enableBtn()">
          </div>
          <div class="form-group" id="emailDiv" hidden>
            <label for="email">*Email address</label>
            <div class="alert alert-warning" role="alert" id="invalid_emailDiv" hidden>Please put in a valid Email (Example@email.com).</div>
            <input type="email" class="form-control" id="email" aria-describedby="emailHelp" placeholder="example@email.com" oninput="validEmail(true), enableBtn()"/>
          </div>
          <div class="form-group" id="password1Div">
            <label for="password1" id="password1Lbl">Password</label>
            <div class="alert alert-warning" role="alert" id="invalid_password1Div" hidden>Cannot be blank!</div>
            <input type="password" class="form-control" id="password1" rows="1" placeholder="**********" oninput="notBlank('password1', true), enableBtn()"/>
          </div>
          <div class="form-group" id="retypeDiv" hidden>
            <label for="retype">*Re-type Password</label>
            <div class="alert alert-warning" role="alert" id="invalid_retypeDiv" hidden>Passwords are not the same!</div>
            <input type="password" class="form-control" id="retype" rows="1" placeholder="**********" oninput="isEqual('password1', 'retype', true), enableBtn()">
          </div>
          <button type="button" class="btn btn-primary" id="loginBtn" onclick="login()" disabled>Login</button>
          <button type="button" class="btn btn-success" onclick="createAccount(), fbLogin()" id ="createBtn">Login with Facebook</button>
        </form>
      </div>
    </div>
  </body>

<script>
  function login()
  {
    if(notBlank('uname', false) == true && notBlank('password1', false) == true)
    {
      var uname = document.getElementById("uname").value;
      var pswd = document.getElementById("password1").value;
      var checkAccount = {uname, pswd};
      if(checkAccount != null)
      {
        //Check if valid account.
        //Redirect Somewhere.
      }
      console.log(account);
    }
  }
  function fbLogin()
  {
    var fbUserId;
    var appId = '1758918304408327'; //from facebook
    var roleArn = 'arn:aws:iam::398804394159:role/User_Table_Role'; //from AWS
    //FB / AWS
    FB.init({appId: appId});
    FB.login(function(response)
    {
      if (response.authResponse)
      {
        AWS.config.credentials = new AWS.WebIdentityCredentials
        ({ //WIF
          RoleArn: roleArn,
          ProviderId: 'graph.facebook.com',
          WebIdentityToken: response.authResponse.accessToken
        });
      }
      else {console.log("Issue logging in");}
      // Load the FB JS SDK asynchronously
      (function(d, s, id)
      {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_US/all.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    });
  }

  function createAccount(uname, firstName, lastName, email, pswd)
  {
    if(notBlank('uname', false) == true && notBlank('firstName', false) == true && notBlank('lastName', false) == true && validEmail(false) == true && isEqual('password1', 'retype', false) == true)
    {
      var pswd = document.getElementById("password1").value;
      let account = {User_Id: "", Email: "", Given_Name: "", Family_Name: ""};
      account.Uname = document.getElementById("uname").value;
      account.Email = document.getElementById("email").value;
      account.Given_Name = document.getElementById("firstName").value;
      account.Family_Name = document.getElementById("lastName").value;
      var promise = sha512(account.Uname + pswd)
      // outputs one combined hashsum of username and password
      promise.then(function(digest)
      {
        console.log(digest);
        var uid = String(digest);
        console.log(uid);
        account.User_Id = uid;

        var fbUserId;
        //var dynamodb = null;
        //var docClient = null;
        var appId = '1758918304408327'; //from facebook
        var roleArn = 'arn:aws:iam::398804394159:policy/User_Table-add '; //from AWS IAM

        dynamodb = new AWS.DynamoDB({region: 'us-east-2'});
        docClient = new AWS.DynamoDB.DocumentClient({service: dynamodb});

        var params =
        {
          Item:
          {
            User_Id: account.User_Id,
            Username: account.Uname,
            Email: account.Email,
            First_Name: account.Given_Name,
            Last_Name: account.Family_Name
          },
          TableName: 'User_Table',
          ConditionExpression: 'attribute_not_exists(User_Id)'
          // ExpressionAttributeNames:{
          //   'itemid':'itemID'
          //},
        }; //end params
        docClient.put(params, function(err, resultData)
        {
          if (err)
          {
            console.log(params);
            console.log(err);
          } else
          {
            console.log(resultData);
          }
        })
      });
    }
    document.getElementById("emailDiv").removeAttribute("hidden");
    document.getElementById("retypeDiv").removeAttribute("hidden");
    document.getElementById("firstNameDiv").removeAttribute("hidden");
    document.getElementById("lastNameDiv").removeAttribute("hidden");
    document.getElementById("unameLbl").innerHTML="*Username";
    document.getElementById("password1Lbl").innerHTML="*Password";
    document.getElementById("loginBtn").innerHTML="I already have an account.";
    document.getElementById("loginBtn").setAttribute("class", "btn btn-link");
    document.getElementById("loginBtn").setAttribute("onClick", "goBack()");
    document.getElementById("loginBtn").removeAttribute("disabled");
    document.getElementById("createBtn").setAttribute("onClick", "createAccount()");
    document.getElementById("createBtn").setAttribute("disabled", "");
  }
  function goBack()
  {
    document.getElementById("emailDiv").setAttribute("hidden", "");
    document.getElementById("retypeDiv").setAttribute("hidden", "");
    document.getElementById("firstNameDiv").setAttribute("hidden", "");
    document.getElementById("lastNameDiv").setAttribute("hidden", "");
    document.getElementById("unameLbl").innerHTML="Username";
    document.getElementById("password1Lbl").innerHTML="Password";
    document.getElementById("loginBtn").innerHTML="Login";
    document.getElementById("loginBtn").setAttribute("class", "btn btn-primary");
    document.getElementById("loginBtn").setAttribute("onClick", "");
    document.getElementById("createBtn").setAttribute("onClick", "createAccount(), fbLogin()");
  }
  function enableBtn()
  {
    //if(notBlank('uname', false) == true && notBlank('firstName', false) == true && notBlank('lastName', false) == true && validEmail(false) == true && isEqual('password1', 'retype', false) == true)
    if(notBlank('uname', false) == true)
    {
      console.log("Success!");
      document.getElementById("createBtn").removeAttribute("disabled");
      return true;
    }
    if(notBlank('uname', false) == true && notBlank('password1', false) == true)
    {
      document.getElementById("loginBtn").removeAttribute("disabled");
    }
  }
</script>

<!-- validInput.js -->
<script src="./validInput.js"></script>

<!-- Dependencies at bottom for faster load time -->


</html>
